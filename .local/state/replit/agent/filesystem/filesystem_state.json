{"file_contents":{"replit.md":{"content":"# Shelfs - Modern Digital Bookstore\n\n## Overview\n\nShelfs is a Flask-based e-commerce platform for purchasing and reading digital books. The application supports role-based access (Customers and Admins), allowing customers to browse books, manage shopping carts, complete purchases, and access their digital library. Administrators can upload books, manage inventory, process orders, and view analytics.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Application Framework\n- **Framework**: Flask (Python web framework)\n- **Rationale**: Flask provides lightweight, flexible routing and template rendering suitable for medium-sized applications\n- **Architecture Pattern**: MVC (Model-View-Controller) with server-side rendering\n- **Template Engine**: Jinja2 for dynamic HTML generation\n\n### Authentication & Authorization\n- **Solution**: Flask-Login with session-based authentication\n- **Password Security**: Werkzeug's password hashing (generate_password_hash/check_password_hash)\n- **Role System**: Two-tier role system (Admin/Customer) stored in User model\n- **Session Management**: Flask's built-in session management with SECRET_KEY\n\n### Database & ORM\n- **Database**: SQLite (file-based database at `sqlite:///kitabghar.db`)\n- **ORM**: Flask-SQLAlchemy\n- **Rationale**: SQLite chosen for simplicity and portability; suitable for development and small-to-medium deployments\n- **Schema Design**: \n  - Relational model with clear foreign key relationships\n  - One-to-many relationships: User‚ÜíOrders, User‚ÜíLibrary, Book‚ÜíReviews\n  - Many-to-many through OrderItem: Orders‚ÜîBooks\n\n### Data Models\n1. **User**: Authentication, role management, relationships to orders and library\n2. **Book**: Core product entity with pricing, inventory (stock), categorization, tags, brief description, and file storage\n3. **Order**: Purchase records with status tracking ('Pending', 'Approved', 'Declined')\n4. **OrderItem**: Junction table linking orders to books with quantity (Integer, default=1) and price_at_purchase\n5. **Library**: User's purchased books collection\n6. **Review**: Rating (1-5) and comment system with one review per user per book\n\n**Recent Changes (November 2025):**\n- Added quantity support to cart and checkout system\n- Enhanced OrderItem model with quantity column for multi-copy purchases\n- Implemented stock reservation system (immediate deduction) to prevent overselling\n- Added cart UI with +/- quantity controls, row totals, and grand total calculations\n- Improved hybrid inventory logic to check post-purchase stock levels\n- Added bulletproof order status transition guards to prevent double-processing\n\n### Frontend Architecture\n- **CSS Framework**: Tailwind CSS (CDN-based)\n- **Icons**: Font Awesome 6.4.0\n- **Design System**: \"Warm Library\" theme\n  - Color palette: Slate backgrounds, Amber accents, warm paper white\n  - Responsive design with mobile-first approach\n- **UI Patterns**: Card-based layouts, split-screen authentication, hero sections with overlays\n\n### File Management\n- **Upload Storage**: Local filesystem (`static/uploads/books/`, `static/uploads/covers/`)\n- **Allowed Formats**: PDF for books, PNG/JPG/JPEG/GIF for covers\n- **File Size Limit**: 16MB maximum\n- **Security**: Werkzeug's secure_filename for sanitization\n\n### Business Logic\n- **Shopping Cart**: Session-based cart storage with quantity support (no database persistence until checkout)\n  - **Quantity Feature**: Users can buy multiple copies of the same book\n  - **Cart Controls**: +/- buttons to adjust quantities, automatic validation against stock levels\n  - **Smart Increment**: Adding an already-in-cart book increases quantity instead of showing error\n  - **Stock Validation**: Cannot add more than available stock, with real-time warnings\n- **Hybrid Order Workflow**: Intelligent stock-based approval system with quantity support\n  - **High Stock (>5 after purchase)**: Orders auto-approved, stock decremented immediately, books added to library instantly\n  - **Low Stock (‚â§5 current or ‚â§5 after purchase)**: Orders set to 'Pending' status, awaiting admin approval, stock reserved immediately\n  - **Out of Stock (0)**: Purchase blocked entirely with error message\n  - Mixed carts trigger pending status for entire order if any item has/would have low stock\n  - **Stock Reservation**: All orders (approved and pending) decrement stock immediately during checkout to prevent overselling\n  - **Admin Decline**: Restores reserved stock back to inventory when order is rejected\n  - **Admin Approve**: Grants library access to pending orders (stock already deducted during checkout)\n- **Inventory Management**: Real-time stock tracking with automatic quantity-aware deduction on checkout, live stock updates via polling API every 5 seconds on product detail pages\n- **Guest Browsing**: Anonymous users can view catalog with limited interactions; clicking book images, titles, or \"View Now\" redirects to login page for purchase access\n- **Order Status System**: Three-tier status (Approved/Pending/Declined) with conditional library access, visual badges, and bulletproof status transition guards\n\n### Admin Features\n- **Dashboard Analytics**: Revenue, order count, book catalog size, user count with real-time data binding\n- **Advanced Visual Analytics**: Interactive Chart.js-powered sales visualization with:\n  - Date range filters (start date, end date) with default to current month\n  - Dynamic grouping options (Daily, Monthly, Yearly revenue aggregation)\n  - Real-time chart updates based on filter selections\n  - Revenue trend visualization showing approved orders only\n- **Book Management**: Upload new books with title, author, price, category, tags, brief descriptions, cover images, and PDF files; delete inventory\n- **Order Processing**: Review all orders with hybrid approval workflow; approve/decline pending low-stock orders\n- **User Management**: View all registered customers with username and email, delete accounts\n\n## External Dependencies\n\n### Python Packages\n- **Flask**: Web framework\n- **Flask-SQLAlchemy**: ORM integration\n- **Flask-Login**: User session management\n- **Werkzeug**: Security utilities and file handling\n\n### Frontend Libraries (CDN)\n- **Tailwind CSS**: Utility-first CSS framework for styling\n- **Font Awesome**: Icon library for UI elements\n- **Chart.js**: Data visualization for admin analytics dashboard\n\n### Media Resources\n- **Unsplash**: External image hosting for book covers and hero sections\n  - Authentication pages: photo-1524995997946-a1c2e315a42f (cozy reading nook)\n  - Storefront hero images\n  - Book cover images (2:3 aspect ratio)\n  - Fallback: Slate-800 background color for image load failures\n\n### File System\n- **Static File Storage**: Local directory structure for uploaded PDFs and cover images\n- **Demo Content**: Auto-generated demo.pdf for immediate functionality","size_bytes":6900},"models.py":{"content":"from flask_sqlalchemy import SQLAlchemy\nfrom flask_login import UserMixin\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom datetime import datetime\n\ndb = SQLAlchemy()\n\nclass User(UserMixin, db.Model):\n    __tablename__ = 'users'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(80), unique=True, nullable=False)\n    email = db.Column(db.String(120), unique=True, nullable=False)\n    password_hash = db.Column(db.String(255), nullable=False)\n    role = db.Column(db.String(20), nullable=False, default='Customer')\n    phone = db.Column(db.String(20))\n    \n    orders = db.relationship('Order', backref='user', lazy=True)\n    library = db.relationship('Library', backref='user', lazy=True)\n    \n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n    \n    def is_admin(self):\n        return self.role == 'Admin'\n\nclass Book(db.Model):\n    __tablename__ = 'books'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(200), nullable=False)\n    author = db.Column(db.String(100), nullable=False)\n    price = db.Column(db.Float, nullable=False)\n    category = db.Column(db.String(50))\n    cover_image = db.Column(db.String(300))\n    file_path = db.Column(db.String(300))\n    tag = db.Column(db.String(50))\n    stock = db.Column(db.Integer, nullable=False, default=50)\n    brief_description = db.Column(db.String(255), nullable=True)\n    \n    order_items = db.relationship('OrderItem', backref='book', lazy=True)\n    library_entries = db.relationship('Library', backref='book', lazy=True)\n    reviews = db.relationship('Review', backref='book', lazy=True, cascade='all, delete-orphan')\n    \n    def average_rating(self):\n        if not self.reviews:\n            return 0\n        return sum(review.rating for review in self.reviews) / len(self.reviews)\n\nclass Order(db.Model):\n    __tablename__ = 'orders'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    total_amount = db.Column(db.Float, nullable=False)\n    date = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n    status = db.Column(db.String(20), nullable=False, default='Pending')\n    \n    items = db.relationship('OrderItem', backref='order', lazy=True, cascade='all, delete-orphan')\n\nclass OrderItem(db.Model):\n    __tablename__ = 'order_items'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    order_id = db.Column(db.Integer, db.ForeignKey('orders.id'), nullable=False)\n    book_id = db.Column(db.Integer, db.ForeignKey('books.id'), nullable=False)\n    price_at_purchase = db.Column(db.Float, nullable=False)\n    quantity = db.Column(db.Integer, nullable=False, default=1)\n\nclass Library(db.Model):\n    __tablename__ = 'library'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    book_id = db.Column(db.Integer, db.ForeignKey('books.id'), nullable=False)\n    \n    __table_args__ = (db.UniqueConstraint('user_id', 'book_id', name='_user_book_uc'),)\n\nclass Review(db.Model):\n    __tablename__ = 'reviews'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    book_id = db.Column(db.Integer, db.ForeignKey('books.id'), nullable=False)\n    rating = db.Column(db.Integer, nullable=False)\n    comment = db.Column(db.Text)\n    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref='reviews')\n","size_bytes":3751},"main.py":{"content":"from flask import Flask, render_template, request, redirect, url_for, session, flash, jsonify, send_file\nfrom flask_login import LoginManager, login_user, logout_user, login_required, current_user\nfrom werkzeug.utils import secure_filename\nfrom models import db, User, Book, Order, OrderItem, Library, Review\nimport os\nfrom datetime import datetime\n\napp = Flask(__name__)\napp.config['SECRET_KEY'] = 'kitabghar-secret-key-2024'\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///kitabghar.db'\napp.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False\napp.config['UPLOAD_FOLDER'] = 'static/uploads'\napp.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024\n\nALLOWED_EXTENSIONS = {'pdf', 'png', 'jpg', 'jpeg', 'gif'}\n\ndb.init_app(app)\n\nlogin_manager = LoginManager()\nlogin_manager.init_app(app)\nlogin_manager.login_view = 'login'\n\n@login_manager.user_loader\ndef load_user(user_id):\n    return User.query.get(int(user_id))\n\ndef allowed_file(filename):\n    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS\n\ndef create_folders():\n    os.makedirs('static/uploads/books', exist_ok=True)\n    os.makedirs('static/uploads/covers', exist_ok=True)\n\ndef create_demo_pdf():\n    demo_pdf_path = 'static/uploads/books/demo.pdf'\n    if not os.path.exists(demo_pdf_path):\n        pdf_content = b\"\"\"%PDF-1.4\n1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n3 0 obj\n<< /Type /Page /Parent 2 0 R /Resources 4 0 R /MediaBox [0 0 612 792] /Contents 5 0 R >>\nendobj\n4 0 obj\n<< /Font << /F1 << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> >> >>\nendobj\n5 0 obj\n<< /Length 100 >>\nstream\nBT\n/F1 24 Tf\n100 700 Td\n(KitabGhar Demo eBook) Tj\n0 -30 Td\n(This is a sample book for demonstration.) Tj\nET\nendstream\nendobj\nxref\n0 6\n0000000000 65535 f \n0000000009 00000 n \n0000000058 00000 n \n0000000115 00000 n \n0000000214 00000 n \n0000000304 00000 n \ntrailer\n<< /Size 6 /Root 1 0 R >>\nstartxref\n456\n%%EOF\"\"\"\n        with open(demo_pdf_path, 'wb') as f:\n            f.write(pdf_content)\n        print(f\"Created demo PDF at {demo_pdf_path}\")\n    return demo_pdf_path\n\ndef seed_data():\n    if User.query.count() == 0:\n        admin = User(username='admin', email='admin@shelfs.com', role='Admin', phone='1234567890')\n        admin.set_password('admin123')\n        \n        user = User(username='reader', email='reader@example.com', role='Customer', phone='9876543210')\n        user.set_password('user123')\n        \n        db.session.add(admin)\n        db.session.add(user)\n        db.session.commit()\n        print(\"Created test users (admin/admin123, reader/user123)\")\n    \n    if Book.query.count() == 0:\n        demo_pdf_path = create_demo_pdf()\n        \n        books = [\n            Book(\n                title='The Alchemist',\n                author='Paulo Coelho',\n                price=299.00,\n                category='Fiction',\n                cover_image='https://images.unsplash.com/photo-1544947950-fa07a98d237f?w=400&h=600&fit=crop',\n                file_path=demo_pdf_path,\n                tag='Shelfs Choice üèÜ',\n                stock=50\n            ),\n            Book(\n                title='Atomic Habits',\n                author='James Clear',\n                price=399.00,\n                category='Self-Help',\n                cover_image='https://images.unsplash.com/photo-1512820790803-83ca734da794?w=400&h=600&fit=crop',\n                file_path=demo_pdf_path,\n                tag='Best Seller üî•',\n                stock=22\n            ),\n            Book(\n                title='Sapiens',\n                author='Yuval Noah Harari',\n                price=499.00,\n                category='History',\n                cover_image='https://images.unsplash.com/photo-1589998059171-988d887df646?w=400&h=600&fit=crop',\n                file_path=demo_pdf_path,\n                tag='Limited Edition üíé',\n                stock=35\n            ),\n            Book(\n                title='Clean Code',\n                author='Robert C. Martin',\n                price=599.00,\n                category='Technology',\n                cover_image='https://images.unsplash.com/photo-1532012197267-da84d127e765?w=400&h=600&fit=crop',\n                file_path=demo_pdf_path,\n                stock=40\n            ),\n            Book(\n                title='The Psychology of Money',\n                author='Morgan Housel',\n                price=349.00,\n                category='Finance',\n                cover_image='https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?w=400&h=600&fit=crop',\n                file_path=demo_pdf_path,\n                tag='Best Seller üî•',\n                stock=25\n            ),\n            Book(\n                title='Educated',\n                author='Tara Westover',\n                price=449.00,\n                category='Biography',\n                cover_image='https://images.unsplash.com/photo-1497633762265-9d179a990aa6?w=400&h=600&fit=crop',\n                file_path=demo_pdf_path,\n                stock=30\n            ),\n            Book(\n                title='The Lean Startup',\n                author='Eric Ries',\n                price=549.00,\n                category='Business',\n                cover_image='https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop',\n                file_path=demo_pdf_path,\n                tag='Shelfs Choice üèÜ',\n                stock=45\n            ),\n            Book(\n                title='Thinking, Fast and Slow',\n                author='Daniel Kahneman',\n                price=599.00,\n                category='Psychology',\n                cover_image='https://images.unsplash.com/photo-1519682337058-a94d519337bc?w=400&h=600&fit=crop',\n                file_path=demo_pdf_path,\n                stock=20\n            ),\n            Book(\n                title='The Power of Now',\n                author='Eckhart Tolle',\n                price=379.00,\n                category='Spirituality',\n                cover_image='https://images.unsplash.com/photo-1506126613408-eca07ce68773?w=400&h=600&fit=crop',\n                file_path=demo_pdf_path,\n                stock=15\n            ),\n            Book(\n                title='1984',\n                author='George Orwell',\n                price=329.00,\n                category='Classic',\n                cover_image='https://images.unsplash.com/photo-1541963463532-d68292c34b19?w=400&h=600&fit=crop',\n                file_path=demo_pdf_path,\n                tag='Limited Edition üíé',\n                stock=18\n            )\n        ]\n        \n        for book in books:\n            db.session.add(book)\n        \n        db.session.commit()\n        print(f\"Database seeded with {len(books)} books with varied stock levels and tags\")\n\n@app.route('/')\ndef index():\n    books = Book.query.all()\n    return render_template('store.html', books=books)\n\n@app.route('/search')\ndef search():\n    category = request.args.get('category', '')\n    author = request.args.get('author', '')\n    \n    query = Book.query\n    \n    if category:\n        query = query.filter(Book.category.ilike(f'%{category}%'))\n    if author:\n        query = query.filter(Book.author.ilike(f'%{author}%'))\n    \n    books = query.all()\n    return render_template('store.html', books=books, search_category=category, search_author=author)\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if current_user.is_authenticated:\n        if current_user.is_admin():\n            return redirect(url_for('admin_dashboard'))\n        return redirect(url_for('index'))\n    \n    if request.method == 'POST':\n        username = request.form.get('username')\n        password = request.form.get('password')\n        \n        user = User.query.filter_by(username=username).first()\n        \n        if user and user.check_password(password):\n            login_user(user)\n            if user.is_admin():\n                return redirect(url_for('admin_dashboard'))\n            return redirect(url_for('index'))\n        else:\n            flash('Invalid username or password', 'error')\n    \n    return render_template('login.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if current_user.is_authenticated:\n        return redirect(url_for('index'))\n    \n    if request.method == 'POST':\n        username = request.form.get('username')\n        email = request.form.get('email')\n        password = request.form.get('password')\n        phone = request.form.get('phone', '')\n        \n        if User.query.filter_by(username=username).first():\n            flash('Username already exists', 'error')\n            return redirect(url_for('register'))\n        \n        if User.query.filter_by(email=email).first():\n            flash('Email already registered', 'error')\n            return redirect(url_for('register'))\n        \n        user = User(username=username, email=email, role='Customer', phone=phone)\n        user.set_password(password)\n        db.session.add(user)\n        db.session.commit()\n        \n        flash('Registration successful! Please login.', 'success')\n        return redirect(url_for('login'))\n    \n    return render_template('register.html')\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    return redirect(url_for('index'))\n\n@app.route('/cart')\n@login_required\ndef cart():\n    cart_items = session.get('cart', [])\n    cart_books = []\n    total = 0\n    \n    for item in cart_items:\n        book = Book.query.get(item['book_id'])\n        if book:\n            quantity = item.get('quantity', 1)\n            row_total = book.price * quantity\n            cart_books.append({\n                'book': book,\n                'quantity': quantity,\n                'row_total': row_total\n            })\n            total += row_total\n    \n    return render_template('cart.html', cart_books=cart_books, total=total)\n\n@app.route('/add-to-cart/<int:book_id>')\n@login_required\ndef add_to_cart(book_id):\n    if current_user.is_admin():\n        flash('Admins cannot purchase books', 'error')\n        return redirect(url_for('index'))\n    \n    book = Book.query.get_or_404(book_id)\n    \n    existing = Library.query.filter_by(user_id=current_user.id, book_id=book_id).first()\n    if existing:\n        flash('You already own this book!', 'info')\n        return redirect(url_for('index'))\n    \n    cart = session.get('cart', [])\n    \n    existing_item = next((item for item in cart if item['book_id'] == book_id), None)\n    \n    if existing_item:\n        if existing_item['quantity'] >= book.stock:\n            flash(f'Cannot add more! Only {book.stock} copies available.', 'error')\n        else:\n            existing_item['quantity'] += 1\n            session['cart'] = cart\n            flash(f'{book.title} quantity increased to {existing_item[\"quantity\"]}!', 'success')\n    else:\n        cart.append({'book_id': book_id, 'quantity': 1})\n        session['cart'] = cart\n        flash(f'{book.title} added to cart!', 'success')\n    \n    return redirect(url_for('index'))\n\n@app.route('/remove-from-cart/<int:book_id>')\n@login_required\ndef remove_from_cart(book_id):\n    cart = session.get('cart', [])\n    cart = [item for item in cart if item['book_id'] != book_id]\n    session['cart'] = cart\n    flash('Item removed from cart', 'success')\n    return redirect(url_for('cart'))\n\n@app.route('/increase-quantity/<int:book_id>')\n@login_required\ndef increase_quantity(book_id):\n    book = Book.query.get_or_404(book_id)\n    cart = session.get('cart', [])\n    \n    for item in cart:\n        if item['book_id'] == book_id:\n            if item['quantity'] >= book.stock:\n                flash(f'Cannot add more! Only {book.stock} copies available.', 'error')\n            else:\n                item['quantity'] += 1\n                session['cart'] = cart\n                flash(f'Quantity increased to {item[\"quantity\"]}', 'success')\n            break\n    \n    return redirect(url_for('cart'))\n\n@app.route('/decrease-quantity/<int:book_id>')\n@login_required\ndef decrease_quantity(book_id):\n    cart = session.get('cart', [])\n    \n    for item in cart:\n        if item['book_id'] == book_id:\n            if item['quantity'] > 1:\n                item['quantity'] -= 1\n                session['cart'] = cart\n                flash(f'Quantity decreased to {item[\"quantity\"]}', 'success')\n            else:\n                cart = [i for i in cart if i['book_id'] != book_id]\n                session['cart'] = cart\n                flash('Item removed from cart', 'success')\n            break\n    \n    return redirect(url_for('cart'))\n\n@app.route('/checkout', methods=['GET', 'POST'])\n@login_required\ndef checkout():\n    if current_user.is_admin():\n        flash('Admins cannot purchase books', 'error')\n        return redirect(url_for('index'))\n    \n    cart_items = session.get('cart', [])\n    \n    if not cart_items:\n        flash('Your cart is empty', 'error')\n        return redirect(url_for('cart'))\n    \n    if request.method == 'POST':\n        total = 0\n        low_stock_items = []\n        \n        for item in cart_items:\n            book = Book.query.get(item['book_id'])\n            quantity = item.get('quantity', 1)\n            if book:\n                if book.stock <= 0:\n                    flash(f'Sorry, {book.title} is out of stock!', 'error')\n                    return redirect(url_for('cart'))\n                if quantity > book.stock:\n                    flash(f'Sorry, only {book.stock} copies of {book.title} available!', 'error')\n                    return redirect(url_for('cart'))\n                \n                remaining_stock = book.stock - quantity\n                if book.stock <= 5 or remaining_stock <= 5:\n                    low_stock_items.append(book.title)\n                \n                total += book.price * quantity\n        \n        if low_stock_items:\n            order_status = 'Pending'\n            auto_approve = False\n        else:\n            order_status = 'Approved'\n            auto_approve = True\n        \n        order = Order(user_id=current_user.id, total_amount=total, status=order_status)\n        db.session.add(order)\n        db.session.flush()\n        \n        for item in cart_items:\n            book = Book.query.get(item['book_id'])\n            quantity = item.get('quantity', 1)\n            if book:\n                book.stock -= quantity\n                \n                if auto_approve:\n                    library_entry = Library.query.filter_by(user_id=current_user.id, book_id=book.id).first()\n                    if not library_entry:\n                        library_entry = Library(user_id=current_user.id, book_id=book.id)\n                        db.session.add(library_entry)\n                \n                order_item = OrderItem(\n                    order_id=order.id,\n                    book_id=book.id,\n                    price_at_purchase=book.price,\n                    quantity=quantity\n                )\n                db.session.add(order_item)\n        \n        db.session.commit()\n        session['cart'] = []\n        \n        if auto_approve:\n            flash(f'Purchase successful! Read now in your library. Total: ‚Çπ{total:.2f}', 'success')\n            return redirect(url_for('my_library'))\n        else:\n            flash(f'Order placed! Awaiting Admin confirmation due to limited stock. Total: ‚Çπ{total:.2f}', 'info')\n            return redirect(url_for('index'))\n    \n    cart_books = []\n    total = 0\n    \n    for item in cart_items:\n        book = Book.query.get(item['book_id'])\n        if book:\n            quantity = item.get('quantity', 1)\n            row_total = book.price * quantity\n            cart_books.append({\n                'book': book,\n                'quantity': quantity,\n                'row_total': row_total\n            })\n            total += row_total\n    \n    return render_template('checkout.html', cart_books=cart_books, total=total)\n\n@app.route('/my-library')\n@login_required\ndef my_library():\n    if current_user.is_admin():\n        flash('Admin accounts do not have a library', 'info')\n        return redirect(url_for('admin_dashboard'))\n    \n    orders = Order.query.filter_by(user_id=current_user.id).order_by(Order.date.desc()).all()\n    order_books = []\n    for order in orders:\n        for item in order.items:\n            order_books.append({\n                'book': item.book,\n                'status': order.status,\n                'order_id': order.id\n            })\n    \n    return render_template('dashboard.html', order_books=order_books)\n\n@app.route('/read/<int:book_id>')\n@login_required\ndef read_book(book_id):\n    library_entry = Library.query.filter_by(user_id=current_user.id, book_id=book_id).first()\n    \n    if not library_entry:\n        flash('You do not own this book', 'error')\n        return redirect(url_for('index'))\n    \n    book = Book.query.get_or_404(book_id)\n    \n    if book.file_path and os.path.exists(book.file_path):\n        return send_file(book.file_path, mimetype='application/pdf')\n    else:\n        flash('PDF file not available for this book', 'error')\n        return redirect(url_for('my_library'))\n\n@app.route('/admin')\n@login_required\ndef admin_dashboard():\n    if not current_user.is_admin():\n        flash('Access denied', 'error')\n        return redirect(url_for('index'))\n    \n    from datetime import datetime as dt, timedelta\n    \n    start_date = request.args.get('start_date')\n    end_date = request.args.get('end_date')\n    frequency = request.args.get('frequency', 'Daily')\n    \n    if not start_date:\n        start_date = (dt.now().replace(day=1)).strftime('%Y-%m-%d')\n    if not end_date:\n        end_date = dt.now().strftime('%Y-%m-%d')\n    \n    total_revenue = db.session.query(db.func.sum(Order.total_amount)).scalar() or 0\n    total_orders = Order.query.count()\n    total_books = Book.query.count()\n    total_users = User.query.filter_by(role='Customer').count()\n    \n    recent_orders = Order.query.order_by(Order.date.desc()).limit(10).all()\n    books = Book.query.all()\n    users = User.query.filter_by(role='Customer').all()\n    \n    start_dt = dt.strptime(start_date, '%Y-%m-%d')\n    end_dt = dt.strptime(end_date, '%Y-%m-%d') + timedelta(days=1)\n    \n    orders = Order.query.filter(\n        Order.status == 'Approved',\n        Order.date >= start_dt,\n        Order.date < end_dt\n    ).order_by(Order.date).all()\n    \n    sales_data = {}\n    for order in orders:\n        if frequency == 'Daily':\n            key = order.date.strftime('%Y-%m-%d')\n        elif frequency == 'Monthly':\n            key = order.date.strftime('%b %Y')\n        elif frequency == 'Yearly':\n            key = order.date.strftime('%Y')\n        else:\n            key = order.date.strftime('%Y-%m-%d')\n        \n        if key in sales_data:\n            sales_data[key] += order.total_amount\n        else:\n            sales_data[key] = order.total_amount\n    \n    labels = list(sales_data.keys())\n    values = list(sales_data.values())\n    \n    return render_template('admin.html', \n                         total_revenue=total_revenue,\n                         total_orders=total_orders,\n                         total_books=total_books,\n                         total_users=total_users,\n                         recent_orders=recent_orders,\n                         books=books,\n                         users=users,\n                         labels=labels,\n                         values=values,\n                         start_date=start_date,\n                         end_date=end_date,\n                         frequency=frequency)\n\n@app.route('/admin/upload', methods=['POST'])\n@login_required\ndef admin_upload():\n    if not current_user.is_admin():\n        flash('Access denied', 'error')\n        return redirect(url_for('index'))\n    \n    title = request.form.get('title')\n    author = request.form.get('author')\n    price = float(request.form.get('price'))\n    category = request.form.get('category')\n    tag = request.form.get('tag') or None\n    stock = int(request.form.get('stock', 50))\n    brief_description = request.form.get('brief_description') or None\n    \n    cover_file = request.files.get('cover')\n    pdf_file = request.files.get('pdf')\n    \n    cover_path = None\n    pdf_path = None\n    \n    if cover_file and allowed_file(cover_file.filename):\n        cover_filename = secure_filename(cover_file.filename)\n        cover_path = os.path.join(app.config['UPLOAD_FOLDER'], 'covers', cover_filename)\n        cover_file.save(cover_path)\n        cover_path = f'/static/uploads/covers/{cover_filename}'\n    \n    if pdf_file and allowed_file(pdf_file.filename):\n        pdf_filename = secure_filename(pdf_file.filename)\n        pdf_path = os.path.join(app.config['UPLOAD_FOLDER'], 'books', pdf_filename)\n        pdf_file.save(pdf_path)\n    \n    book = Book(\n        title=title,\n        author=author,\n        price=price,\n        category=category,\n        cover_image=cover_path or 'https://placehold.co/600x900',\n        file_path=pdf_path,\n        tag=tag,\n        stock=stock,\n        brief_description=brief_description\n    )\n    \n    db.session.add(book)\n    db.session.commit()\n    \n    flash(f'Book \"{title}\" uploaded successfully!', 'success')\n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/users')\n@login_required\ndef admin_users():\n    if not current_user.is_admin():\n        flash('Access denied', 'error')\n        return redirect(url_for('index'))\n    \n    users = User.query.filter_by(role='Customer').all()\n    return render_template('admin_users.html', users=users)\n\n@app.route('/delete_book/<int:book_id>')\n@login_required\ndef delete_book(book_id):\n    if not current_user.is_admin():\n        flash('Access denied', 'error')\n        return redirect(url_for('index'))\n    \n    book = Book.query.get_or_404(book_id)\n    book_title = book.title\n    \n    db.session.delete(book)\n    db.session.commit()\n    \n    flash(f'Book \"{book_title}\" has been deleted successfully!', 'success')\n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/book/<int:book_id>')\ndef book_details(book_id):\n    book = Book.query.get_or_404(book_id)\n    reviews = Review.query.filter_by(book_id=book_id).order_by(Review.created_at.desc()).all()\n    return render_template('book_details.html', book=book, reviews=reviews)\n\n@app.route('/book/<int:book_id>/review', methods=['POST'])\n@login_required\ndef add_review(book_id):\n    book = Book.query.get_or_404(book_id)\n    rating = int(request.form.get('rating'))\n    comment = request.form.get('comment')\n    \n    existing_review = Review.query.filter_by(user_id=current_user.id, book_id=book_id).first()\n    if existing_review:\n        flash('You have already reviewed this book', 'info')\n        return redirect(url_for('book_details', book_id=book_id))\n    \n    review = Review(user_id=current_user.id, book_id=book_id, rating=rating, comment=comment)\n    db.session.add(review)\n    db.session.commit()\n    \n    flash('Review added successfully!', 'success')\n    return redirect(url_for('book_details', book_id=book_id))\n\n@app.route('/admin/approve_order/<int:order_id>')\n@login_required\ndef approve_order(order_id):\n    if not current_user.is_admin():\n        flash('Access denied', 'error')\n        return redirect(url_for('index'))\n    \n    order = Order.query.get_or_404(order_id)\n    \n    if order.status == 'Approved':\n        flash('This order has already been approved', 'info')\n        return redirect(url_for('admin_dashboard'))\n    \n    if order.status == 'Declined':\n        flash('Cannot approve a declined order. Stock was already restored.', 'error')\n        return redirect(url_for('admin_dashboard'))\n    \n    if order.status != 'Pending':\n        flash('Invalid order status', 'error')\n        return redirect(url_for('admin_dashboard'))\n    \n    for item in order.items:\n        book = Book.query.get(item.book_id)\n        if book:\n            library_entry = Library.query.filter_by(user_id=order.user_id, book_id=book.id).first()\n            if not library_entry:\n                library_entry = Library(user_id=order.user_id, book_id=book.id)\n                db.session.add(library_entry)\n    \n    order.status = 'Approved'\n    db.session.commit()\n    \n    flash(f'Order #{order.id} approved successfully!', 'success')\n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/decline_order/<int:order_id>')\n@login_required\ndef decline_order(order_id):\n    if not current_user.is_admin():\n        flash('Access denied', 'error')\n        return redirect(url_for('index'))\n    \n    order = Order.query.get_or_404(order_id)\n    \n    if order.status == 'Approved':\n        flash('Cannot decline an already approved order', 'error')\n        return redirect(url_for('admin_dashboard'))\n    \n    if order.status == 'Declined':\n        flash('This order has already been declined', 'info')\n        return redirect(url_for('admin_dashboard'))\n    \n    if order.status != 'Pending':\n        flash('Invalid order status', 'error')\n        return redirect(url_for('admin_dashboard'))\n    \n    for item in order.items:\n        book = Book.query.get(item.book_id)\n        if book:\n            book.stock += item.quantity\n    \n    order.status = 'Declined'\n    db.session.commit()\n    \n    flash(f'Order #{order.id} declined and stock restored', 'info')\n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/delete_user/<int:user_id>')\n@login_required\ndef delete_user(user_id):\n    if not current_user.is_admin():\n        flash('Access denied', 'error')\n        return redirect(url_for('index'))\n    \n    user = User.query.get_or_404(user_id)\n    \n    if user.is_admin():\n        flash('Cannot delete admin users', 'error')\n        return redirect(url_for('admin_dashboard'))\n    \n    username = user.username\n    db.session.delete(user)\n    db.session.commit()\n    \n    flash(f'User \"{username}\" has been deleted successfully!', 'success')\n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/sales_data')\n@login_required\ndef sales_data():\n    if not current_user.is_admin():\n        return jsonify({'error': 'Access denied'}), 403\n    \n    orders = Order.query.filter_by(status='Approved').order_by(Order.date).all()\n    \n    daily_sales = {}\n    for order in orders:\n        date_key = order.date.strftime('%Y-%m-%d')\n        if date_key in daily_sales:\n            daily_sales[date_key] += order.total_amount\n        else:\n            daily_sales[date_key] = order.total_amount\n    \n    labels = list(daily_sales.keys())\n    data = list(daily_sales.values())\n    \n    return jsonify({\n        'labels': labels,\n        'data': data\n    })\n\n@app.route('/api/stock/<int:book_id>')\ndef get_stock(book_id):\n    book = Book.query.get_or_404(book_id)\n    return jsonify({\n        'stock': book.stock\n    })\n\nif __name__ == '__main__':\n    with app.app_context():\n        create_folders()\n        db.create_all()\n        seed_data()\n    app.run(host='0.0.0.0', port=5000, debug=True)\n","size_bytes":26906},"pyproject.toml":{"content":"[tool.poetry]\nname = \"python-template\"\nversion = \"0.1.0\"\ndescription = \"\"\nauthors = [\"Your Name <you@example.com>\"]\n\n[tool.poetry.dependencies]\npython = \">=3.11.0,<3.12\"\nflask = \"^3.0.0\"\ngunicorn = \"^21.2.0\"\nflask-login = \"^0.6.3\"\nflask-sqlalchemy = \"^3.1.1\"\nwerkzeug = \"^3.1.3\"\n\n[tool.pyright]\n# https://github.com/microsoft/pyright/blob/main/docs/configuration.md\nuseLibraryCodeForTypes = true\nexclude = [\".cache\"]\n\n[tool.ruff]\n# https://beta.ruff.rs/docs/configuration/\nselect = ['E', 'W', 'F', 'I', 'B', 'C4', 'ARG', 'SIM']\nignore = ['W291', 'W292', 'W293']\n\n[build-system]\nrequires = [\"poetry-core>=1.0.0\"]\nbuild-backend = \"poetry.core.masonry.api\"","size_bytes":653}},"version":2}